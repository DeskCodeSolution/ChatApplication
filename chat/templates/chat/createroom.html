<!DOCTYPE html>
<html>
<head>
    <title>Chat Application</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 250px;
            background-color: #f5f5f5;
            border-right: 1px solid #ddd;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #ddd;
            background-color: #4a76a8;
            color: white;
        }

        .user-list {
            flex-grow: 1;
            overflow-y: auto;
        }

        .user-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            list-style: none;
        }

        .user-item:hover {
            background-color: #e9f0f7;
        }

        .main-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f9f9f9;
        }

        .add-user-btn {
            margin: 15px;
            padding: 10px;
            background-color: #4a76a8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            max-width: 500px;
            max-height: 80%;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="sidebar">
        <div class="sidebar-header" id = "user-side">
            <h3>Chats</h3>
            <button class="add-user-btn" id="addUsersButton">Add Users</button>
        </div>
        <div class="user-list" id="usersList">

        </div>
    </div>

    <div class="main-content">
        <h2>Select a user to start chatting</h2>
    </div>

    <script>

        const pathParts = window.location.pathname.split('/').filter(Boolean)
        const userName = pathParts[2]
        userId = pathParts[3]
        const userSide = document.getElementById("user-side");


        const headerTitle = userSide.querySelector("h3");
        if (headerTitle) {
            headerTitle.textContent = userName;
        }

        document.addEventListener('DOMContentLoaded', function() {

            fetchExistingChats();

            function fetchExistingChats() {
                const token = JSON.parse(localStorage.getItem('chatToken_'+userId));
                token_access = token.access
                console.log("token in createroom", token)

                return fetch(`http://127.0.0.1:8000/chat/LoadContentData/`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token_access}`
                    }
                })

                .then(response => {
                    console.log("response", response)
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("data", data)
                    console.log("data.data", data.data)


                    if(data) {
                        localStorage.setItem('chatData_' + userId, JSON.stringify(data.data));
                        displayExistingChats(data.data);

                    }

                })
                .catch(error => {
                    console.error('Error fetching chats:', error);
                    const savedData = localStorage.getItem('chatData_' + userId);
                    console.log("savedData", savedData)
                    if (savedData) {
                        console.log("get data from local")
                        displayExistingChats(JSON.parse(savedData));
                    }
                });
            }

            function displayExistingChats(chats) {

                const usersList = document.getElementById('usersList');
                selectedUsers = [];

                chats.forEach(chat => {
    
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.textContent = chat.name;
                    userItem.dataset.userId = chat.id;
                    userItem.dataset.roomId = chat.roomId;
                    selectedUsers.push({
                        name: chat.name,
                        id: chat.id
                    });

                    userItem.addEventListener('click', function() {
                        window.location.href = `/chat/${chat.roomId}/${userId}/`;
                    });

                    usersList.appendChild(userItem);
                });
            }



            const addButton = document.getElementById('addUsersButton');
            const usersList = document.getElementById('usersList');
            let selectedUsers = [];

            addButton.addEventListener('click', function() {
                console.log("addButton click")
                let modal = document.createElement('div');
                modal.className = 'modal';

                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';

                const closeButton = document.createElement('button');
                closeButton.textContent = 'X';
                closeButton.style.cssText = 'float:right; cursor:pointer; font-weight:bold;';

                modalContent.appendChild(closeButton);

                closeButton.addEventListener('click', function() {
                    console.log("close button");
                    document.body.removeChild(modal);
                });
                modalContent.innerHTML += '<h3>Select User</h3>';


                const userListContainer = document.createElement('div');
                modalContent.appendChild(userListContainer);

                modal.appendChild(modalContent);
                document.body.appendChild(modal);

                const token = JSON.parse(localStorage.getItem('chatToken_'+userId));
                token_access = token.access

                fetch('http://127.0.0.1:8000/chat/user_register/',
                {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token_access}`
                    }
                }

                )
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        userListContainer.innerHTML = '';
                        const userList = document.createElement('ul');
                        userList.style.listStyleType = 'none';
                        userList.style.padding = '0';

                        const list = data.data;

                        list.forEach(user => {
                            if (selectedUsers.some(selectedUser => selectedUser.id === user.id)) {
                                return;
                            }

                            const listItem = document.createElement('li');
                            listItem.style.padding = '8px';
                            listItem.style.cursor = 'pointer';
                            listItem.style.borderBottom = '1px solid #eee';

                            const radio = document.createElement('input');
                            radio.type = 'radio';
                            radio.name = 'selectedUser';
                            radio.value = user.name;
                            radio.dataset.userId = user.id;
                            radio.id = 'user_' + user.id;

                            const label = document.createElement('label');
                            label.htmlFor = 'user_' + user.id;
                            label.textContent = user.name;
                            label.style.marginLeft = '10px';

                            listItem.appendChild(radio);
                            listItem.appendChild(label);
                            userList.appendChild(listItem);
                        });

                        userListContainer.appendChild(userList);

                        const selectButton = document.createElement('button');
                        selectButton.textContent = 'Add Selected User';
                        selectButton.style.marginTop = '15px';
                        selectButton.style.padding = '8px 12px';
                        selectButton.style.backgroundColor = '#4a76a8';
                        selectButton.style.color = 'white';
                        selectButton.style.border = 'none';
                        selectButton.style.borderRadius = '4px';
                        selectButton.style.cursor = 'pointer';




                        selectButton.onclick = function() {
                            const selected = userListContainer.querySelector('input[name=selectedUser]:checked');


                            if (selected) {
                                const selectedUser = {
                                    name: selected.value,
                                    id: selected.dataset.userId
                                };


                                if (!selectedUsers.some(user => user.id === selectedUser.id)) {
                                    selectedUsers.push(selectedUser);
                                    addUserToSidebar(selectedUser);
                                }

                                console.log("Selected Users:", selectedUsers);
                            }

                            document.body.removeChild(modal);
                        };

                        modalContent.appendChild(selectButton);
                    })
                    .catch(error => {
                        console.error('Error fetching users:', error);
                        userListContainer.innerHTML = '<p>Error loading users. Please try again.</p>';
                    });
            });

            function addUserToSidebar(user) {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.textContent = user.name;
                userItem.dataset.userId = user.id;

                const participants = [user.name, userName].sort();
                const roomId = participants.join('_');

                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

                    fetch('http://127.0.0.1:8000/chat/room_management/', {
                      method: 'POST',
                      headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                      },
                      body: JSON.stringify({
                        roomId: roomId,
                        users: [userId,user.id]
                      })
                    })
                    .then((response) => {
                      if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                      }
                      return response.json();
                    })
                    .then((responseData) => {
                      console.log("Response Data:", responseData);
                      if (responseData) {
                        console.log("data is printed")
                      }
                    })
                    .catch(error => {
                      console.error('Error:', error);
                    });


                userItem.addEventListener('click', function() {
                    console.log("navigating the the chatroom")
                    window.location.href = `/chat/${roomId}/${userId}/`;
                });

                usersList.appendChild(userItem);
            }
        });
    </script>
</body>
</html>
